<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Course Supplement Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex" />

  <!-- PDF.js from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      background: #111;
      color: white;
      font-family: system-ui, -apple-system, sans-serif;
      overflow: hidden; /* scroll inside the main container, not the body */
    }

    /* Top toolbar */
    .toolbar {
      background: #111;
      border-bottom: 1px solid #222;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      font-size: 14px;
      z-index: 2;
    }

    .toolbar .group {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .toolbar .sep {
      width: 1px;
      height: 24px;
      background: #333;
    }

    .toolbar button {
      background: #222;
      color: white;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
      white-space: nowrap;
    }

    .toolbar button:hover {
      background: #333;
    }

    .toolbar input[type="text"] {
      background: #1a1a1a;
      border: 1px solid #333;
      padding: 6px 8px;
      border-radius: 4px;
      color: white;
      min-width: 160px;
    }

    #searchStatus {
      font-size: 12px;
      opacity: 0.7;
    }

    /* Main layout: pages + thumbnails */
    .container {
      display: flex;
      height: calc(100vh - 52px); /* adjust if toolbar height changes */
      overflow: hidden;
    }

    /* Scrollable PDF page area */
    #pdfScrollArea {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .pdf-page {
      display: block;
      margin: 0 auto 30px auto;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
      background: #222;
      width: 100%;   /* responsive width; height controlled by aspect ratio */
      height: auto;
    }

    /* Right thumbnail bar */
    #thumbSidebar {
      width: 150px;
      background: #181818;
      border-left: 1px solid #222;
      overflow-y: auto;
      padding: 12px;
      transition: width 0.25s ease, padding 0.25s ease;
    }

    #thumbSidebar.hidden {
      width: 0;
      padding: 0;
      border-left: none;
    }

    .thumb {
      width: 100%;
      margin-bottom: 12px;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s, transform 0.1s;
      box-sizing: border-box;
    }

    .thumb:hover {
      opacity: 1;
      transform: translateY(-1px);
    }

    .thumb.selected {
      border: 2px solid #4da3ff;
      opacity: 1;
    }

    /* Simple loading / error text */
    #message {
      position: absolute;
      top: 56px;
      left: 16px;
      font-size: 13px;
      opacity: 0.7;
      pointer-events: none;
    }

    @media (max-width: 768px) {
      .container {
        height: calc(100vh - 60px);
      }
      #thumbSidebar {
        width: 110px;
      }
    }
  </style>
</head>
<body>
  <div id="message">Loading PDF…</div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="group">
      <button id="toggleThumbsBtn">Hide Thumbnails</button>
    </div>

    <div class="sep"></div>

    <div class="group">
      <button id="zoomOutBtn">−</button>
      <button id="zoomInBtn">+</button>
      <span id="zoomLabel">100%</span>
    </div>

    <div class="sep"></div>

    <div class="group">
      <input id="searchInput" type="text" placeholder="Search…" />
      <button id="searchBtn">Find</button>
      <span id="searchStatus"></span>
    </div>
  </div>

  <!-- Main area: pages + thumbnails -->
  <div class="container">
    <div id="pdfScrollArea"></div>
    <div id="thumbSidebar"></div>
  </div>

  <script>
    // PDF.js setup
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    const DEFAULT_PDF_URL = "p/htftmcs.pdf";
    const urlParams = new URLSearchParams(window.location.search);
    let pdfPath = urlParams.get("file") || DEFAULT_PDF_URL;

    // Safety: don't allow absolute external URLs
    if (/^https?:\/\//i.test(pdfPath)) {
      pdfPath = DEFAULT_PDF_URL;
    }

    const pdfScrollArea = document.getElementById("pdfScrollArea");
    const thumbSidebar = document.getElementById("thumbSidebar");
    const toggleThumbsBtn = document.getElementById("toggleThumbsBtn");
    const searchInput = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");
    const searchStatus = document.getElementById("searchStatus");
    const message = document.getElementById("message");
    const zoomOutBtn = document.getElementById("zoomOutBtn");
    const zoomInBtn = document.getElementById("zoomInBtn");
    const zoomLabel = document.getElementById("zoomLabel");

    let pdfDoc = null;
    let pageScaleBase = 1.0;      // base scale; we compute zoomFactor to fit
    let zoomFactor = 1.0;         // multiplier adjusted by auto-fit and buttons
    const minZoom = 0.2;
    const maxZoom = 3.0;

    // Search state
    let searchResults = [];       // [{ page: number }]
    let searchIndex = -1;         // current result index
    let lastSearchQuery = "";

    function setMessage(text) {
      message.textContent = text || "";
    }

    function updateZoomLabel() {
      zoomLabel.textContent = Math.round(zoomFactor * 100) + "%";
    }

    /* -----------------------
       Load PDF
    ------------------------ */
    pdfjsLib
      .getDocument(pdfPath)
      .promise.then(async function (pdf) {
        pdfDoc = pdf;
        setMessage("Calculating initial zoom…");

        await computeInitialZoom();   // fit-to-width based on page 1
        updateZoomLabel();

        setMessage("Rendering pages…");
        await renderDocument();
        setMessage("");
      })
      .catch(function (err) {
        console.error("Error loading PDF:", err);
        setMessage("Error loading PDF.");
        pdfScrollArea.innerHTML =
          '<div style="color:#f66;font-size:14px;">Error loading PDF.</div>';
      });

    /* -----------------------
       Compute initial zoom for fit-to-width
    ------------------------ */
    async function computeInitialZoom() {
      if (!pdfDoc) return;

      const containerWidth =
        pdfScrollArea.clientWidth || window.innerWidth || 800;

      const page = await pdfDoc.getPage(1);
      const viewport = page.getViewport({ scale: 1.0 });
      const pageWidth = viewport.width;

      if (!pageWidth) {
        zoomFactor = 1.0;
        return;
      }

      const targetScale = (containerWidth - 40) / pageWidth;
      zoomFactor = Math.max(minZoom, Math.min(maxZoom, targetScale));
    }

    /* -----------------------
       Render all pages + thumbnails
    ------------------------ */
    async function renderDocument() {
      if (!pdfDoc) return;

      pdfScrollArea.innerHTML = "";
      thumbSidebar.innerHTML = "";

      const numPages = pdfDoc.numPages;
      const pagePromises = [];

      for (let pageNum = 1; pageNum <= numPages; pageNum++) {
        pagePromises.push(renderPage(pageNum));
        renderThumbnail(pageNum);
      }

      await Promise.all(pagePromises);
      highlightThumb(1);
    }

    /* -----------------------
       Render full pages (vertical stack)
    ------------------------ */
    async function renderPage(pageNum) {
      try {
        const page = await pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({
          scale: pageScaleBase * zoomFactor
        });

        const canvas = document.createElement("canvas");
        canvas.className = "pdf-page";
        canvas.id = "page-" + pageNum;

        const context = canvas.getContext("2d");

        const outputScale = window.devicePixelRatio || 1;
        const width = viewport.width;
        const height = viewport.height;

        canvas.width = width * outputScale;
        canvas.height = height * outputScale;

        canvas.style.width = width + "px";
        // height is auto via CSS .pdf-page

        const transform =
          outputScale !== 1 ? [outputScale, 0, 0, outputScale, 0, 0] : null;

        await page.render({
          canvasContext: context,
          viewport: viewport,
          transform: transform
        }).promise;

        pdfScrollArea.appendChild(canvas);
      } catch (e) {
        console.error("Error rendering page " + pageNum, e);
      }
    }

    /* -----------------------
       Thumbnails on the right
    ------------------------ */
    async function renderThumbnail(pageNum) {
      try {
        const page = await pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({ scale: 0.25 });

        const canvas = document.createElement("canvas");
        canvas.className = "thumb";
        canvas.id = "thumb-" + pageNum;

        const context = canvas.getContext("2d");
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        await page.render({
          canvasContext: context,
          viewport: viewport
        }).promise;

        canvas.addEventListener("click", () => {
          const target = document.getElementById("page-" + pageNum);
          if (target) {
            target.scrollIntoView({
              behavior: "smooth",
              block: "start"
            });
            highlightThumb(pageNum);
          }
        });

        thumbSidebar.appendChild(canvas);
      } catch (e) {
        console.error("Error rendering thumbnail " + pageNum, e);
      }
    }

    function highlightThumb(pageNum) {
      document
        .querySelectorAll(".thumb")
        .forEach((t) => t.classList.remove("selected"));
      const target = document.getElementById("thumb-" + pageNum);
      if (target) target.classList.add("selected");
    }

    /* -----------------------
       Toggle thumbnails
    ------------------------ */
    toggleThumbsBtn.addEventListener("click", () => {
      if (thumbSidebar.classList.contains("hidden")) {
        thumbSidebar.classList.remove("hidden");
        toggleThumbsBtn.textContent = "Hide Thumbnails";
      } else {
        thumbSidebar.classList.add("hidden");
        toggleThumbsBtn.textContent = "Show Thumbnails";
      }
    });

    /* -----------------------
       Zoom controls
    ------------------------ */
    zoomInBtn.addEventListener("click", () => {
      zoomFactor = Math.min(maxZoom, zoomFactor * 1.2);
      updateZoomLabel();
      renderDocument().then(() => jumpToCurrentSearchIfAny());
    });

    zoomOutBtn.addEventListener("click", () => {
      zoomFactor = Math.max(minZoom, zoomFactor / 1.2);
      updateZoomLabel();
      renderDocument().then(() => jumpToCurrentSearchIfAny());
    });

    /* -----------------------
       Search with multiple results
    ------------------------ */
    function normalize(str) {
      return (str || "").toLowerCase();
    }

    async function buildSearchResults(query) {
      searchResults = [];
      searchIndex = -1;

      if (!pdfDoc) return;

      const qNorm = normalize(query);
      const numPages = pdfDoc.numPages;

      for (let p = 1; p <= numPages; p++) {
        const page = await pdfDoc.getPage(p);
        const textContent = await page.getTextContent();
        const fullText = textContent.items.map((i) => i.str).join(" ");
        const normText = normalize(fullText);

        let idx = normText.indexOf(qNorm);
        while (idx !== -1) {
          searchResults.push({ page: p });
          idx = normText.indexOf(qNorm, idx + qNorm.length);
        }
      }
    }

    function goToSearchResult(index) {
      if (!searchResults.length) return;
      const boundedIndex = ((index % searchResults.length) + searchResults.length) % searchResults.length;
      searchIndex = boundedIndex;

      const res = searchResults[searchIndex];
      const target = document.getElementById("page-" + res.page);
      if (target) {
        target.scrollIntoView({
          behavior: "smooth",
          block: "start"
        });
        highlightThumb(res.page);
      }

      searchStatus.textContent =
        "Match " +
        (searchIndex + 1) +
        " of " +
        searchResults.length +
        " (use arrow keys to move)";
    }

    function nextSearchResult() {
      if (!searchResults.length) return;
      goToSearchResult(
        searchIndex < 0 ? 0 : searchIndex + 1
      );
    }

    function prevSearchResult() {
      if (!searchResults.length) return;
      goToSearchResult(
        searchIndex < 0 ? searchResults.length - 1 : searchIndex - 1
      );
    }

    async function performSearch() {
      if (!pdfDoc) return;

      const query = searchInput.value.trim();
      if (!query) {
        searchResults = [];
        searchIndex = -1;
        lastSearchQuery = "";
        searchStatus.textContent = "";
        return;
      }

      // If new query, rebuild results
      if (query !== lastSearchQuery) {
        lastSearchQuery = query;
        searchStatus.textContent = "Searching…";
        await buildSearchResults(query);
      }

      if (!searchResults.length) {
        searchStatus.textContent = "No matches found.";
        return;
      }

      // Move to next result
      nextSearchResult();
    }

    function jumpToCurrentSearchIfAny() {
      if (searchIndex >= 0 && searchIndex < searchResults.length) {
        goToSearchResult(searchIndex);
      }
    }

    searchBtn.addEventListener("click", performSearch);
    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        performSearch();
      }
    });

    // Keyboard navigation for search results: arrow keys
    window.addEventListener("keydown", (e) => {
      if (!searchResults.length) return;

      if (e.key === "ArrowRight" || e.key === "ArrowDown") {
        e.preventDefault();
        nextSearchResult();
      } else if (e.key === "ArrowLeft" || e.key === "ArrowUp") {
        e.preventDefault();
        prevSearchResult();
      }
    });
  </script>
</body>
</html>
